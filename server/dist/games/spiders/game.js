"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const _1 = require("./");
// <<-- Creer-Merge: imports -->>
const utils_1 = require("~/utils");
// <<-- /Creer-Merge: imports -->>
/**
 * There's an infestation of enemy spiders challenging your queen broodmother
 * spider! Protect her and attack the other broodmother in this turn based,
 * node based, game.
 */
class SpidersGame extends _1.BaseClasses.Game {
    // <<-- Creer-Merge: attributes -->>
    // Any additional member attributes can go here
    // NOTE: They will not be sent to the AIs, those must be defined
    // in the creer file.
    // <<-- /Creer-Merge: attributes -->>
    /**
     * Called when a Game is created.
     *
     * @param settingsManager - The manager that holds initial settings.
     * @param required - Data required to initialize this (ignore it).
     */
    constructor(settingsManager, required) {
        super(settingsManager, required);
        this.settingsManager = settingsManager;
        /** The settings used to initialize the game, as set by players */
        this.settings = Object.freeze(this.settingsManager.values);
        // <<-- Creer-Merge: constructor -->>
        const mapWidth = 400;
        const mapHeight = 200;
        const deadzone = 25;
        const maxNests = 48; // per side, as are the mirrored
        const minNests = 8;
        const maxWebs = 20;
        const minWebs = 0;
        const minCrossWebs = 0;
        const maxCrossWebs = 4;
        // generare Nests on the left
        let numNests = this.manager.random.int(maxNests, minNests);
        // Try to place nests this many times before giving up because the map
        // is probably too congested
        let retries = 1000;
        for (let i = 0; i < numNests; i++) {
            while (--retries > 0) {
                let point = {
                    x: this.manager.random.int(mapWidth / 2 - deadzone / 2),
                    y: this.manager.random.int(mapHeight),
                };
                for (const nest of this.nests) {
                    if (utils_1.euclideanDistance(nest, point) <= deadzone) {
                        point = undefined;
                        break;
                    }
                }
                if (point) {
                    this.nests.push(this.manager.create.nest(point));
                    break; // out of while(retries), as the point was valid
                }
            }
        }
        // re-set just incase we had to abort above due to congestion
        numNests = this.nests.length;
        if (!utils_1.arrayHasElements(this.nests)) {
            throw new Error("Spiders game has no nests!");
        }
        // generate Webs on the left
        const numWebs = this.manager.random.int(maxWebs, minWebs);
        for (let i = 0; i < numWebs; i++) {
            const nestA = this.manager.random.element(this.nests);
            if (!nestA) {
                throw new Error("No nests to create Webs.");
            }
            let nestB = nestA;
            while (nestB === nestA) {
                nestB = this.manager.random.element(this.nests);
            }
            this.manager.create.web({ nestA, nestB });
        }
        // create the BroodMother
        this.players[0].broodMother = this.manager.create.broodMother({
            owner: this.players[0],
            nest: this.manager.random.element(this.nests),
        });
        // now mirror it
        // mirror the Nests
        const mirrorNests = new Map();
        for (let i = 0; i < numNests; i++) {
            const mirroring = this.nests[i];
            const mirrored = this.manager.create.nest({
                x: mapWidth - mirroring.x,
                y: mirroring.y,
            });
            // these are not exposed to competitors
            mirrorNests.set(mirroring, mirrored);
            mirrorNests.set(mirrored, mirroring);
        }
        // mirror the Webs
        for (const web of this.webs) {
            if (!web.hasNotSnapped()) {
                throw new Error("Invalid web on game creation!");
            }
            // get mirror the nests
            const nestA = mirrorNests.get(web.nestA);
            const nestB = mirrorNests.get(web.nestB);
            this.manager.create.web({ nestA, nestB });
        }
        // webs that cross the middle of the game
        const numCrossWebs = this.manager.random.int(minCrossWebs, maxCrossWebs);
        for (let i = 0; i < numCrossWebs; i++) {
            // the first half the the array has the nests on player 0's side
            const nestA = this.nests[this.manager.random.int(numNests - 1)];
            // and the other half has player 1's
            const nestB = this.nests[this.manager.random.int(numNests, numNests * 2 - 1)];
            this.manager.create.web({ nestA, nestB });
            const mirrorA = mirrorNests.get(nestA);
            const mirrorB = mirrorNests.get(nestB);
            if (mirrorNests.get(nestA) !== nestB) {
                // this is the mirror of the web created above, so long as the nests don't mirror each other already
                this.manager.create.web({ nestA: mirrorA, nestB: mirrorB });
            }
        }
        // mirror the BroodMother
        const secondPlayer = this.players[1];
        const nest0 = this.players[0].broodMother.nest;
        if (!nest0) {
            throw new Error("Player 0's BroodMother has no nest!");
        }
        const mirrorNest = mirrorNests.get(nest0);
        if (!mirrorNest) {
            throw new Error("Player 1's BroodMother has no nest!");
        }
        secondPlayer.broodMother = this.manager.create.broodMother({
            owner: this.players[1],
            nest: mirrorNest,
        });
        // <<-- /Creer-Merge: constructor -->>
    }
}
exports.SpidersGame = SpidersGame;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2FtZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9nYW1lcy9zcGlkZXJzL2dhbWUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQSx5QkFBaUM7QUFRakMsaUNBQWlDO0FBQ2pDLG1DQUErRTtBQUkvRSxrQ0FBa0M7QUFFbEM7Ozs7R0FJRztBQUNILE1BQWEsV0FBWSxTQUFRLGNBQVcsQ0FBQyxJQUFJO0lBa0c3QyxvQ0FBb0M7SUFFcEMsK0NBQStDO0lBQy9DLGdFQUFnRTtJQUNoRSxxQkFBcUI7SUFFckIscUNBQXFDO0lBRXJDOzs7OztPQUtHO0lBQ0gsWUFDYyxlQUEyQyxFQUNyRCxRQUF5QztRQUV6QyxLQUFLLENBQUMsZUFBZSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBSHZCLG9CQUFlLEdBQWYsZUFBZSxDQUE0QjtRQTdHekQsa0VBQWtFO1FBQ2xELGFBQVEsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUM7UUFpSGxFLHFDQUFxQztRQUVyQyxNQUFNLFFBQVEsR0FBRyxHQUFHLENBQUM7UUFDckIsTUFBTSxTQUFTLEdBQUcsR0FBRyxDQUFDO1FBQ3RCLE1BQU0sUUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNwQixNQUFNLFFBQVEsR0FBRyxFQUFFLENBQUMsQ0FBQyxnQ0FBZ0M7UUFDckQsTUFBTSxRQUFRLEdBQUcsQ0FBQyxDQUFDO1FBQ25CLE1BQU0sT0FBTyxHQUFHLEVBQUUsQ0FBQztRQUNuQixNQUFNLE9BQU8sR0FBRyxDQUFDLENBQUM7UUFDbEIsTUFBTSxZQUFZLEdBQUcsQ0FBQyxDQUFDO1FBQ3ZCLE1BQU0sWUFBWSxHQUFHLENBQUMsQ0FBQztRQUV2Qiw2QkFBNkI7UUFDN0IsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUUzRCxzRUFBc0U7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QUFJLEtBQUssQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDO1NBQzFEO1FBQ0QsWUFBWSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUM7WUFDdkQsS0FBSyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBQ3RCLElBQUksRUFBRSxVQUFVO1NBQ25CLENBQUMsQ0FBQztRQUVILHNDQUFzQztJQUMxQyxDQUFDO0NBZUo7QUF2UUQsa0NBdVFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSUJhc2VHYW1lUmVxdWlyZWREYXRhIH0gZnJvbSBcIn4vY29yZS9nYW1lXCI7XG5pbXBvcnQgeyBCYXNlQ2xhc3NlcyB9IGZyb20gXCIuL1wiO1xuaW1wb3J0IHsgU3BpZGVyc0dhbWVNYW5hZ2VyIH0gZnJvbSBcIi4vZ2FtZS1tYW5hZ2VyXCI7XG5pbXBvcnQgeyBHYW1lT2JqZWN0IH0gZnJvbSBcIi4vZ2FtZS1vYmplY3RcIjtcbmltcG9ydCB7IFNwaWRlcnNHYW1lU2V0dGluZ3NNYW5hZ2VyIH0gZnJvbSBcIi4vZ2FtZS1zZXR0aW5nc1wiO1xuaW1wb3J0IHsgTmVzdCB9IGZyb20gXCIuL25lc3RcIjtcbmltcG9ydCB7IFBsYXllciB9IGZyb20gXCIuL3BsYXllclwiO1xuaW1wb3J0IHsgV2ViIH0gZnJvbSBcIi4vd2ViXCI7XG5cbi8vIDw8LS0gQ3JlZXItTWVyZ2U6IGltcG9ydHMgLS0+PlxuaW1wb3J0IHsgYXJyYXlIYXNFbGVtZW50cywgZXVjbGlkZWFuRGlzdGFuY2UsIElQb2ludCwgTXV0YWJsZSB9IGZyb20gXCJ+L3V0aWxzXCI7XG5cbi8qKiBBIFBsYXllciB0aGF0IGNhbiBtdXRhdGUgYmVmb3JlIHRoZSBnYW1lIGJlZ2lucyAqL1xudHlwZSBNdXRhYmxlUGxheWVyID0gTXV0YWJsZTxQbGF5ZXI+O1xuLy8gPDwtLSAvQ3JlZXItTWVyZ2U6IGltcG9ydHMgLS0+PlxuXG4vKipcbiAqIFRoZXJlJ3MgYW4gaW5mZXN0YXRpb24gb2YgZW5lbXkgc3BpZGVycyBjaGFsbGVuZ2luZyB5b3VyIHF1ZWVuIGJyb29kbW90aGVyXG4gKiBzcGlkZXIhIFByb3RlY3QgaGVyIGFuZCBhdHRhY2sgdGhlIG90aGVyIGJyb29kbW90aGVyIGluIHRoaXMgdHVybiBiYXNlZCxcbiAqIG5vZGUgYmFzZWQsIGdhbWUuXG4gKi9cbmV4cG9ydCBjbGFzcyBTcGlkZXJzR2FtZSBleHRlbmRzIEJhc2VDbGFzc2VzLkdhbWUge1xuICAgIC8qKiBUaGUgbWFuYWdlciBvZiB0aGlzIGdhbWUsIHRoYXQgY29udHJvbHMgZXZlcnl0aGluZyBhcm91bmQgaXQgKi9cbiAgICBwdWJsaWMgcmVhZG9ubHkgbWFuYWdlciE6IFNwaWRlcnNHYW1lTWFuYWdlcjtcblxuICAgIC8qKiBUaGUgc2V0dGluZ3MgdXNlZCB0byBpbml0aWFsaXplIHRoZSBnYW1lLCBhcyBzZXQgYnkgcGxheWVycyAqL1xuICAgIHB1YmxpYyByZWFkb25seSBzZXR0aW5ncyA9IE9iamVjdC5mcmVlemUodGhpcy5zZXR0aW5nc01hbmFnZXIudmFsdWVzKTtcblxuICAgIC8qKlxuICAgICAqIFRoZSBwbGF5ZXIgd2hvc2UgdHVybiBpdCBpcyBjdXJyZW50bHkuIFRoYXQgcGxheWVyIGNhbiBzZW5kIGNvbW1hbmRzLlxuICAgICAqIE90aGVyIHBsYXllcnMgY2Fubm90LlxuICAgICAqL1xuICAgIHB1YmxpYyBjdXJyZW50UGxheWVyITogUGxheWVyO1xuXG4gICAgLyoqXG4gICAgICogVGhlIGN1cnJlbnQgdHVybiBudW1iZXIsIHN0YXJ0aW5nIGF0IDAgZm9yIHRoZSBmaXJzdCBwbGF5ZXIncyB0dXJuLlxuICAgICAqL1xuICAgIHB1YmxpYyBjdXJyZW50VHVybiE6IG51bWJlcjtcblxuICAgIC8qKlxuICAgICAqIFRoZSBzcGVlZCBhdCB3aGljaCBDdXR0ZXJzIHdvcmsgdG8gZG8gY3V0IFdlYnMuXG4gICAgICovXG4gICAgcHVibGljIHJlYWRvbmx5IGN1dFNwZWVkITogbnVtYmVyO1xuXG4gICAgLyoqXG4gICAgICogQ29uc3RhbnQgdXNlZCB0byBjYWxjdWxhdGUgaG93IG1hbnkgZWdncyBCcm9vZE1vdGhlcnMgZ2V0IG9uIHRoZWlyXG4gICAgICogb3duZXIncyB0dXJucy5cbiAgICAgKi9cbiAgICBwdWJsaWMgcmVhZG9ubHkgZWdnc1NjYWxhciE6IG51bWJlcjtcblxuICAgIC8qKlxuICAgICAqIEEgbWFwcGluZyBvZiBldmVyeSBnYW1lIG9iamVjdCdzIElEIHRvIHRoZSBhY3R1YWwgZ2FtZSBvYmplY3QuIFByaW1hcmlseVxuICAgICAqIHVzZWQgYnkgdGhlIHNlcnZlciBhbmQgY2xpZW50IHRvIGVhc2lseSByZWZlciB0byB0aGUgZ2FtZSBvYmplY3RzIHZpYVxuICAgICAqIElELlxuICAgICAqL1xuICAgIHB1YmxpYyBnYW1lT2JqZWN0cyE6IHtbaWQ6IHN0cmluZ106IEdhbWVPYmplY3R9O1xuXG4gICAgLyoqXG4gICAgICogVGhlIHN0YXJ0aW5nIHN0cmVuZ3RoIGZvciBXZWJzLlxuICAgICAqL1xuICAgIHB1YmxpYyByZWFkb25seSBpbml0aWFsV2ViU3RyZW5ndGghOiBudW1iZXI7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgbWF4aW11bSBudW1iZXIgb2YgdHVybnMgYmVmb3JlIHRoZSBnYW1lIHdpbGwgYXV0b21hdGljYWxseSBlbmQuXG4gICAgICovXG4gICAgcHVibGljIHJlYWRvbmx5IG1heFR1cm5zITogbnVtYmVyO1xuXG4gICAgLyoqXG4gICAgICogVGhlIG1heGltdW0gc3RyZW5ndGggYSB3ZWIgY2FuIGJlIHN0cmVuZ3RoZW5lZCB0by5cbiAgICAgKi9cbiAgICBwdWJsaWMgcmVhZG9ubHkgbWF4V2ViU3RyZW5ndGghOiBudW1iZXI7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgc3BlZWQgYXQgd2hpY2ggU3BpZGVybGluZ3MgbW92ZSBvbiBXZWJzLlxuICAgICAqL1xuICAgIHB1YmxpYyByZWFkb25seSBtb3ZlbWVudFNwZWVkITogbnVtYmVyO1xuXG4gICAgLyoqXG4gICAgICogRXZlcnkgTmVzdCBpbiB0aGUgZ2FtZS5cbiAgICAgKi9cbiAgICBwdWJsaWMgbmVzdHMhOiBOZXN0W107XG5cbiAgICAvKipcbiAgICAgKiBMaXN0IG9mIGFsbCB0aGUgcGxheWVycyBpbiB0aGUgZ2FtZS5cbiAgICAgKi9cbiAgICBwdWJsaWMgcGxheWVycyE6IFBsYXllcltdO1xuXG4gICAgLyoqXG4gICAgICogQSB1bmlxdWUgaWRlbnRpZmllciBmb3IgdGhlIGdhbWUgaW5zdGFuY2UgdGhhdCBpcyBiZWluZyBwbGF5ZWQuXG4gICAgICovXG4gICAgcHVibGljIHJlYWRvbmx5IHNlc3Npb24hOiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgc3BlZWQgYXQgd2hpY2ggU3BpdHRlcnMgd29yayB0byBzcGl0IG5ldyBXZWJzLlxuICAgICAqL1xuICAgIHB1YmxpYyByZWFkb25seSBzcGl0U3BlZWQhOiBudW1iZXI7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgYW1vdW50IG9mIHRpbWUgKGluIG5hbm8tc2Vjb25kcykgYWRkZWQgYWZ0ZXIgZWFjaCBwbGF5ZXIgcGVyZm9ybXMgYVxuICAgICAqIHR1cm4uXG4gICAgICovXG4gICAgcHVibGljIHJlYWRvbmx5IHRpbWVBZGRlZFBlclR1cm4hOiBudW1iZXI7XG5cbiAgICAvKipcbiAgICAgKiBIb3cgbXVjaCB3ZWIgc3RyZW5ndGggaXMgYWRkZWQgb3IgcmVtb3ZlZCBmcm9tIFdlYnMgd2hlbiB0aGV5IGFyZVxuICAgICAqIHdlYXZlZC5cbiAgICAgKi9cbiAgICBwdWJsaWMgcmVhZG9ubHkgd2VhdmVQb3dlciE6IG51bWJlcjtcblxuICAgIC8qKlxuICAgICAqIFRoZSBzcGVlZCBhdCB3aGljaCBXZWF2ZXJzIHdvcmsgdG8gZG8gc3RyZW5ndGhlbnMgYW5kIHdlYWtlbnMgb24gV2Vicy5cbiAgICAgKi9cbiAgICBwdWJsaWMgcmVhZG9ubHkgd2VhdmVTcGVlZCE6IG51bWJlcjtcblxuICAgIC8qKlxuICAgICAqIEV2ZXJ5IFdlYiBpbiB0aGUgZ2FtZS5cbiAgICAgKi9cbiAgICBwdWJsaWMgd2VicyE6IFdlYltdO1xuXG4gICAgLy8gPDwtLSBDcmVlci1NZXJnZTogYXR0cmlidXRlcyAtLT4+XG5cbiAgICAvLyBBbnkgYWRkaXRpb25hbCBtZW1iZXIgYXR0cmlidXRlcyBjYW4gZ28gaGVyZVxuICAgIC8vIE5PVEU6IFRoZXkgd2lsbCBub3QgYmUgc2VudCB0byB0aGUgQUlzLCB0aG9zZSBtdXN0IGJlIGRlZmluZWRcbiAgICAvLyBpbiB0aGUgY3JlZXIgZmlsZS5cblxuICAgIC8vIDw8LS0gL0NyZWVyLU1lcmdlOiBhdHRyaWJ1dGVzIC0tPj5cblxuICAgIC8qKlxuICAgICAqIENhbGxlZCB3aGVuIGEgR2FtZSBpcyBjcmVhdGVkLlxuICAgICAqXG4gICAgICogQHBhcmFtIHNldHRpbmdzTWFuYWdlciAtIFRoZSBtYW5hZ2VyIHRoYXQgaG9sZHMgaW5pdGlhbCBzZXR0aW5ncy5cbiAgICAgKiBAcGFyYW0gcmVxdWlyZWQgLSBEYXRhIHJlcXVpcmVkIHRvIGluaXRpYWxpemUgdGhpcyAoaWdub3JlIGl0KS5cbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJvdGVjdGVkIHNldHRpbmdzTWFuYWdlcjogU3BpZGVyc0dhbWVTZXR0aW5nc01hbmFnZXIsXG4gICAgICAgIHJlcXVpcmVkOiBSZWFkb25seTxJQmFzZUdhbWVSZXF1aXJlZERhdGE+LFxuICAgICkge1xuICAgICAgICBzdXBlcihzZXR0aW5nc01hbmFnZXIsIHJlcXVpcmVkKTtcblxuICAgICAgICAvLyA8PC0tIENyZWVyLU1lcmdlOiBjb25zdHJ1Y3RvciAtLT4+XG5cbiAgICAgICAgY29uc3QgbWFwV2lkdGggPSA0MDA7XG4gICAgICAgIGNvbnN0IG1hcEhlaWdodCA9IDIwMDtcbiAgICAgICAgY29uc3QgZGVhZHpvbmUgPSAyNTtcbiAgICAgICAgY29uc3QgbWF4TmVzdHMgPSA0ODsgLy8gcGVyIHNpZGUsIGFzIGFyZSB0aGUgbWlycm9yZWRcbiAgICAgICAgY29uc3QgbWluTmVzdHMgPSA4O1xuICAgICAgICBjb25zdCBtYXhXZWJzID0gMjA7XG4gICAgICAgIGNvbnN0IG1pbldlYnMgPSAwO1xuICAgICAgICBjb25zdCBtaW5Dcm9zc1dlYnMgPSAwO1xuICAgICAgICBjb25zdCBtYXhDcm9zc1dlYnMgPSA0O1xuXG4gICAgICAgIC8vIGdlbmVyYXJlIE5lc3RzIG9uIHRoZSBsZWZ0XG4gICAgICAgIGxldCBudW1OZXN0cyA9IHRoaXMubWFuYWdlci5yYW5kb20uaW50KG1heE5lc3RzLCBtaW5OZXN0cyk7XG5cbiAgICAgICAgLy8gVHJ5IHRvIHBsYWNlIG5lc3RzIHRoaXMgbWFueSB0aW1lcyBiZWZvcmUgZ2l2aW5nIHVwIGJlY2F1c2UgdGhlIG1hcFxuICAgICAgICAvLyBpcyBwcm9iYWJseSB0b28gY29uZ2VzdGVkXG4gICAgICAgIGxldCByZXRyaWVzID0gMTAwMDtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1OZXN0czsgaSsrKSB7XG4gICAgICAgICAgICB3aGlsZSAoLS1yZXRyaWVzID4gMCkge1xuICAgICAgICAgICAgICAgIGxldCBwb2ludDogSVBvaW50IHwgdW5kZWZpbmVkID0ge1xuICAgICAgICAgICAgICAgICAgICB4OiB0aGlzLm1hbmFnZXIucmFuZG9tLmludChtYXBXaWR0aCAvIDIgLSBkZWFkem9uZSAvIDIpLFxuICAgICAgICAgICAgICAgICAgICB5OiB0aGlzLm1hbmFnZXIucmFuZG9tLmludChtYXBIZWlnaHQpLFxuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IG5lc3Qgb2YgdGhpcy5uZXN0cykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXVjbGlkZWFuRGlzdGFuY2UobmVzdCwgcG9pbnQpIDw9IGRlYWR6b25lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwb2ludCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKHBvaW50KSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubmVzdHMucHVzaCh0aGlzLm1hbmFnZXIuY3JlYXRlLm5lc3QocG9pbnQpKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7IC8vIG91dCBvZiB3aGlsZShyZXRyaWVzKSwgYXMgdGhlIHBvaW50IHdhcyB2YWxpZFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHJlLXNldCBqdXN0IGluY2FzZSB3ZSBoYWQgdG8gYWJvcnQgYWJvdmUgZHVlIHRvIGNvbmdlc3Rpb25cbiAgICAgICAgbnVtTmVzdHMgPSB0aGlzLm5lc3RzLmxlbmd0aDtcblxuICAgICAgICBpZiAoIWFycmF5SGFzRWxlbWVudHModGhpcy5uZXN0cykpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlNwaWRlcnMgZ2FtZSBoYXMgbm8gbmVzdHMhXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gZ2VuZXJhdGUgV2VicyBvbiB0aGUgbGVmdFxuICAgICAgICBjb25zdCBudW1XZWJzID0gdGhpcy5tYW5hZ2VyLnJhbmRvbS5pbnQobWF4V2VicywgbWluV2Vicyk7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtV2ViczsgaSsrKSB7XG4gICAgICAgICAgICBjb25zdCBuZXN0QSA9IHRoaXMubWFuYWdlci5yYW5kb20uZWxlbWVudCh0aGlzLm5lc3RzKTtcbiAgICAgICAgICAgIGlmICghbmVzdEEpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJObyBuZXN0cyB0byBjcmVhdGUgV2Vicy5cIik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBuZXN0QjogTmVzdCB8IHVuZGVmaW5lZCA9IG5lc3RBO1xuICAgICAgICAgICAgd2hpbGUgKG5lc3RCID09PSBuZXN0QSkge1xuICAgICAgICAgICAgICAgIG5lc3RCID0gdGhpcy5tYW5hZ2VyLnJhbmRvbS5lbGVtZW50KHRoaXMubmVzdHMpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLm1hbmFnZXIuY3JlYXRlLndlYih7IG5lc3RBLCBuZXN0QiB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGNyZWF0ZSB0aGUgQnJvb2RNb3RoZXJcbiAgICAgICAgKHRoaXMucGxheWVyc1swXSBhcyBNdXRhYmxlUGxheWVyKS5icm9vZE1vdGhlciA9IHRoaXMubWFuYWdlci5jcmVhdGUuYnJvb2RNb3RoZXIoe1xuICAgICAgICAgICAgb3duZXI6IHRoaXMucGxheWVyc1swXSxcbiAgICAgICAgICAgIG5lc3Q6IHRoaXMubWFuYWdlci5yYW5kb20uZWxlbWVudCh0aGlzLm5lc3RzKSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gbm93IG1pcnJvciBpdFxuXG4gICAgICAgIC8vIG1pcnJvciB0aGUgTmVzdHNcbiAgICAgICAgY29uc3QgbWlycm9yTmVzdHMgPSBuZXcgTWFwPE5lc3QsIE5lc3Q+KCk7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtTmVzdHM7IGkrKykge1xuICAgICAgICAgICAgY29uc3QgbWlycm9yaW5nID0gdGhpcy5uZXN0c1tpXTtcbiAgICAgICAgICAgIGNvbnN0IG1pcnJvcmVkID0gdGhpcy5tYW5hZ2VyLmNyZWF0ZS5uZXN0KHtcbiAgICAgICAgICAgICAgICB4OiBtYXBXaWR0aCAtIG1pcnJvcmluZy54LFxuICAgICAgICAgICAgICAgIHk6IG1pcnJvcmluZy55LFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIC8vIHRoZXNlIGFyZSBub3QgZXhwb3NlZCB0byBjb21wZXRpdG9yc1xuICAgICAgICAgICAgbWlycm9yTmVzdHMuc2V0KG1pcnJvcmluZywgbWlycm9yZWQpO1xuICAgICAgICAgICAgbWlycm9yTmVzdHMuc2V0KG1pcnJvcmVkLCBtaXJyb3JpbmcpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gbWlycm9yIHRoZSBXZWJzXG4gICAgICAgIGZvciAoY29uc3Qgd2ViIG9mIHRoaXMud2Vicykge1xuICAgICAgICAgICAgaWYgKCF3ZWIuaGFzTm90U25hcHBlZCgpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSW52YWxpZCB3ZWIgb24gZ2FtZSBjcmVhdGlvbiFcIik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIGdldCBtaXJyb3IgdGhlIG5lc3RzXG4gICAgICAgICAgICBjb25zdCBuZXN0QSA9IG1pcnJvck5lc3RzLmdldCh3ZWIubmVzdEEpO1xuICAgICAgICAgICAgY29uc3QgbmVzdEIgPSBtaXJyb3JOZXN0cy5nZXQod2ViLm5lc3RCKTtcblxuICAgICAgICAgICAgdGhpcy5tYW5hZ2VyLmNyZWF0ZS53ZWIoeyBuZXN0QSwgbmVzdEIgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyB3ZWJzIHRoYXQgY3Jvc3MgdGhlIG1pZGRsZSBvZiB0aGUgZ2FtZVxuICAgICAgICBjb25zdCBudW1Dcm9zc1dlYnMgPSB0aGlzLm1hbmFnZXIucmFuZG9tLmludChtaW5Dcm9zc1dlYnMsIG1heENyb3NzV2Vicyk7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtQ3Jvc3NXZWJzOyBpKyspIHtcbiAgICAgICAgICAgIC8vIHRoZSBmaXJzdCBoYWxmIHRoZSB0aGUgYXJyYXkgaGFzIHRoZSBuZXN0cyBvbiBwbGF5ZXIgMCdzIHNpZGVcbiAgICAgICAgICAgIGNvbnN0IG5lc3RBID0gdGhpcy5uZXN0c1t0aGlzLm1hbmFnZXIucmFuZG9tLmludChudW1OZXN0cyAtIDEpXTtcbiAgICAgICAgICAgICAvLyBhbmQgdGhlIG90aGVyIGhhbGYgaGFzIHBsYXllciAxJ3NcbiAgICAgICAgICAgIGNvbnN0IG5lc3RCID0gdGhpcy5uZXN0c1t0aGlzLm1hbmFnZXIucmFuZG9tLmludChudW1OZXN0cywgbnVtTmVzdHMgKiAyIC0gMSldO1xuICAgICAgICAgICAgdGhpcy5tYW5hZ2VyLmNyZWF0ZS53ZWIoeyBuZXN0QSwgbmVzdEIgfSk7XG5cbiAgICAgICAgICAgIGNvbnN0IG1pcnJvckEgPSBtaXJyb3JOZXN0cy5nZXQobmVzdEEpO1xuICAgICAgICAgICAgY29uc3QgbWlycm9yQiA9IG1pcnJvck5lc3RzLmdldChuZXN0Qik7XG4gICAgICAgICAgICBpZiAobWlycm9yTmVzdHMuZ2V0KG5lc3RBKSAhPT0gbmVzdEIpIHtcbiAgICAgICAgICAgICAgICAvLyB0aGlzIGlzIHRoZSBtaXJyb3Igb2YgdGhlIHdlYiBjcmVhdGVkIGFib3ZlLCBzbyBsb25nIGFzIHRoZSBuZXN0cyBkb24ndCBtaXJyb3IgZWFjaCBvdGhlciBhbHJlYWR5XG4gICAgICAgICAgICAgICAgdGhpcy5tYW5hZ2VyLmNyZWF0ZS53ZWIoeyBuZXN0QTogbWlycm9yQSwgbmVzdEI6IG1pcnJvckIgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBtaXJyb3IgdGhlIEJyb29kTW90aGVyXG4gICAgICAgIGNvbnN0IHNlY29uZFBsYXllcjogTXV0YWJsZVBsYXllciA9IHRoaXMucGxheWVyc1sxXTtcbiAgICAgICAgY29uc3QgbmVzdDAgPSB0aGlzLnBsYXllcnNbMF0uYnJvb2RNb3RoZXIubmVzdDtcbiAgICAgICAgaWYgKCFuZXN0MCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiUGxheWVyIDAncyBCcm9vZE1vdGhlciBoYXMgbm8gbmVzdCFcIik7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgbWlycm9yTmVzdCA9IG1pcnJvck5lc3RzLmdldChuZXN0MCk7XG4gICAgICAgIGlmICghbWlycm9yTmVzdCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiUGxheWVyIDEncyBCcm9vZE1vdGhlciBoYXMgbm8gbmVzdCFcIik7XG4gICAgICAgIH1cbiAgICAgICAgc2Vjb25kUGxheWVyLmJyb29kTW90aGVyID0gdGhpcy5tYW5hZ2VyLmNyZWF0ZS5icm9vZE1vdGhlcih7XG4gICAgICAgICAgICBvd25lcjogdGhpcy5wbGF5ZXJzWzFdLFxuICAgICAgICAgICAgbmVzdDogbWlycm9yTmVzdCxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gPDwtLSAvQ3JlZXItTWVyZ2U6IGNvbnN0cnVjdG9yIC0tPj5cbiAgICB9XG5cbiAgICAvLyA8PC0tIENyZWVyLU1lcmdlOiBwdWJsaWMtZnVuY3Rpb25zIC0tPj5cblxuICAgIC8vIEFueSBwdWJsaWMgZnVuY3Rpb25zIGNhbiBnbyBoZXJlIGZvciBvdGhlciB0aGluZ3MgaW4gdGhlIGdhbWUgdG8gdXNlLlxuICAgIC8vIE5PVEU6IENsaWVudCBBSXMgY2Fubm90IGNhbGwgdGhlc2UgZnVuY3Rpb25zLCB0aG9zZSBtdXN0IGJlIGRlZmluZWRcbiAgICAvLyBpbiB0aGUgY3JlZXIgZmlsZS5cblxuICAgIC8vIDw8LS0gL0NyZWVyLU1lcmdlOiBwdWJsaWMtZnVuY3Rpb25zIC0tPj5cblxuICAgIC8vIDw8LS0gQ3JlZXItTWVyZ2U6IHByb3RlY3RlZC1wcml2YXRlLWZ1bmN0aW9ucyAtLT4+XG5cbiAgICAvLyBBbnkgYWRkaXRpb25hbCBwcm90ZWN0ZWQgb3IgcGlyYXRlIG1ldGhvZHMgY2FuIGdvIGhlcmUuXG5cbiAgICAvLyA8PC0tIC9DcmVlci1NZXJnZTogcHJvdGVjdGVkLXByaXZhdGUtZnVuY3Rpb25zIC0tPj5cbn1cbiJdfQ==