"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const base_game_delta_mergeables_1 = require("./base-game-delta-mergeables");
const base_game_object_factory_1 = require("./base-game-object-factory");
/** The base game that all Game classes inherit from. */
class BaseGame extends base_game_delta_mergeables_1.BaseGameDeltaMergeables {
    /**
     * Initializes a game. Should **only** be done by this game's manager.
     *
     * @param settingsManager - The settings manager for this instance.
     * @param requiredData - The required initialization data.
     */
    constructor(settingsManager, requiredData) {
        super({
            key: "game",
            parent: requiredData.rootDeltaMergeable,
            attributesSchema: requiredData.schema.attributes,
            initialValues: settingsManager.values,
        });
        this.settingsManager = settingsManager;
        /**
         * The actual setting values we will use to initialize things.
         */
        this.settings = Object.freeze(this.settingsManager.values);
        // Our super has now created our delta mergeables,
        // let's reach in and grab the game objects all hack-y like.
        // tslint:disable-next-line:no-any no-non-null-assertion
        const gameObjectsDeltaMergeable = this.deltaMergeable.child("gameObjects");
        this.manager = requiredData.manager;
        this.name = requiredData.namespace.gameName;
        this.session = requiredData.sessionID;
        const clients = requiredData.playingClients;
        for (let i = 0; i < clients.length; i++) {
            const client = clients[i];
            client.aiManager.game = this; // kind of hack-y, we are hooking this up here
            const playerData = {
                name: this.settings.playerNames[i] || client.name || `Player ${i}`,
                clientType: client.programmingLanguage || "Unknown",
            };
            const player = base_game_object_factory_1.createGameObject({
                id: requiredData.playerIDs[i],
                game: this,
                gameObjectsDeltaMergeable,
                gameObjectName: "Player",
                GameObjectClass: requiredData.namespace.Player,
                gameNamespace: requiredData.namespace,
                data: playerData,
            });
            player.timeRemaining = this.settings.playerStartingTime;
            player.ai = new requiredData.namespace.AI(client.aiManager);
            client.setPlayer(player);
            this.players.push(player);
        }
        requiredData.gameCreated.emit({
            game: this,
            gameObjectsDeltaMergeable,
        });
    }
}
exports.BaseGame = BaseGame;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS1nYW1lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NvcmUvZ2FtZS9iYXNlL2Jhc2UtZ2FtZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUlBLDZFQUF1RTtBQUl2RSx5RUFBOEQ7QUE2QjlELHdEQUF3RDtBQUN4RCxNQUFhLFFBQVMsU0FBUSxvREFBdUI7SUE2QmpEOzs7OztPQUtHO0lBQ0gsWUFDYyxlQUF3QyxFQUNsRCxZQUE2QztRQUU3QyxLQUFLLENBQUM7WUFDRixHQUFHLEVBQUUsTUFBTTtZQUNYLE1BQU0sRUFBRSxZQUFZLENBQUMsa0JBQWtCO1lBQ3ZDLGdCQUFnQixFQUFFLFlBQVksQ0FBQyxNQUFNLENBQUMsVUFBVTtZQUNoRCxhQUFhLEVBQUUsZUFBZSxDQUFDLE1BQU07U0FDeEMsQ0FBQyxDQUFDO1FBUk8sb0JBQWUsR0FBZixlQUFlLENBQXlCO1FBN0J0RDs7V0FFRztRQUNhLGFBQVEsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUM7UUFvQ2xFLGtEQUFrRDtRQUNsRCw0REFBNEQ7UUFDNUQsd0RBQXdEO1FBQ3hELE1BQU0seUJBQXlCLEdBQUssSUFBWSxDQUFDLGNBQWlDLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBRSxDQUFDO1FBRXpHLElBQUksQ0FBQyxPQUFPLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQztRQUVwQyxJQUFJLENBQUMsSUFBSSxHQUFHLFlBQVksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDO1FBQzVDLElBQUksQ0FBQyxPQUFPLEdBQUcsWUFBWSxDQUFDLFNBQVMsQ0FBQztRQUV0QyxNQUFNLE9BQU8sR0FBRyxZQUFZLENBQUMsY0FBYyxDQUFDO1FBQzVDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQ3JDLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMxQixNQUFNLENBQUMsU0FBUyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsQ0FBQyw4Q0FBOEM7WUFFNUUsTUFBTSxVQUFVLEdBQW9CO2dCQUNoQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDLElBQUksSUFBSSxVQUFVLENBQUMsRUFBRTtnQkFDbEUsVUFBVSxFQUFFLE1BQU0sQ0FBQyxtQkFBbUIsSUFBSSxTQUFTO2FBQ3RELENBQUM7WUFFRixNQUFNLE1BQU0sR0FBRywyQ0FBZ0IsQ0FBYTtnQkFDeEMsRUFBRSxFQUFFLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO2dCQUM3QixJQUFJLEVBQUUsSUFBSTtnQkFDVix5QkFBeUI7Z0JBQ3pCLGNBQWMsRUFBRSxRQUFRO2dCQUN4QixlQUFlLEVBQUUsWUFBWSxDQUFDLFNBQVMsQ0FBQyxNQUFNO2dCQUM5QyxhQUFhLEVBQUUsWUFBWSxDQUFDLFNBQVM7Z0JBQ3JDLElBQUksRUFBRSxVQUFVO2FBQ25CLENBQUMsQ0FBQztZQUVILE1BQU0sQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxrQkFBa0IsQ0FBQztZQUN4RCxNQUFNLENBQUMsRUFBRSxHQUFHLElBQUksWUFBWSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBRTVELE1BQU0sQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDekIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDN0I7UUFFRCxZQUFZLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQztZQUMxQixJQUFJLEVBQUUsSUFBSTtZQUNWLHlCQUF5QjtTQUM1QixDQUFDLENBQUM7SUFDUCxDQUFDO0NBQ0o7QUF4RkQsNEJBd0ZDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXZlbnQgfSBmcm9tIFwidHMtdHlwZWQtZXZlbnRzXCI7XG5pbXBvcnQgeyBCYXNlUGxheWluZ0NsaWVudCB9IGZyb20gXCJ+L2NvcmUvY2xpZW50c1wiO1xuaW1wb3J0IHsgRGVsdGFNZXJnZWFibGUgfSBmcm9tIFwifi9jb3JlL2dhbWUvZGVsdGEtbWVyZ2VhYmxlXCI7XG5pbXBvcnQgeyBJbW11dGFibGUgfSBmcm9tIFwifi91dGlsc1wiO1xuaW1wb3J0IHsgQmFzZUdhbWVEZWx0YU1lcmdlYWJsZXMgfSBmcm9tIFwiLi9iYXNlLWdhbWUtZGVsdGEtbWVyZ2VhYmxlc1wiO1xuaW1wb3J0IHsgQmFzZUdhbWVNYW5hZ2VyIH0gZnJvbSBcIi4vYmFzZS1nYW1lLW1hbmFnZXJcIjtcbmltcG9ydCB7IElCYXNlR2FtZU5hbWVzcGFjZSwgSUJhc2VHYW1lT2JqZWN0U2NoZW1hIH0gZnJvbSBcIi4vYmFzZS1nYW1lLW5hbWVzcGFjZVwiO1xuaW1wb3J0IHsgQmFzZUdhbWVPYmplY3QgfSBmcm9tIFwiLi9iYXNlLWdhbWUtb2JqZWN0XCI7XG5pbXBvcnQgeyBjcmVhdGVHYW1lT2JqZWN0IH0gZnJvbSBcIi4vYmFzZS1nYW1lLW9iamVjdC1mYWN0b3J5XCI7XG5pbXBvcnQgeyBCYXNlR2FtZVNldHRpbmdzTWFuYWdlciB9IGZyb20gXCIuL2Jhc2UtZ2FtZS1zZXR0aW5nc1wiO1xuaW1wb3J0IHsgQmFzZVBsYXllciwgSUJhc2VQbGF5ZXJEYXRhIH0gZnJvbSBcIi4vYmFzZS1wbGF5ZXJcIjtcblxuLyoqIEFyZ3VtZW50cyBhIGdhbWUgaW5zdGFuY2Ugd2lsbCBuZWVkIHRvIGluaXRpYWxpemUuICovXG5leHBvcnQgaW50ZXJmYWNlIElCYXNlR2FtZVJlcXVpcmVkRGF0YSB7XG4gICAgLyoqIFRoZSBzZXNzaW9uIGlkIHRoaXMgR2FtZSBpcyBpbi4gKi9cbiAgICBzZXNzaW9uSUQ6IHN0cmluZztcbiAgICAvKiogVGhlIGFycmF5IG9mIGNsaWVudHMgdGhhdCBhcmUgcGxheWluZyB0aGlzIEdhbWUuICovXG4gICAgcGxheWluZ0NsaWVudHM6IFJlYWRvbmx5PEJhc2VQbGF5aW5nQ2xpZW50W10+OyAvLyBjbGllbnRzIHdpbGwgbXV0YXRlXG4gICAgLyoqIFRoZSByb290IERlbHRhTWVyZ2FibGUgdGhhdCByZXByZXNlbnRzIHRoZSBlbnRpcmUgZ2FtZSBzdHJ1Y3R1cmUuICovXG4gICAgcm9vdERlbHRhTWVyZ2VhYmxlOiBEZWx0YU1lcmdlYWJsZTtcbiAgICAvKiogVGhlIElEcyBvZiB0aGUgcGxheWVycyBpbiB0aGlzIGdhbWUuICovXG4gICAgcGxheWVySURzOiBJbW11dGFibGU8c3RyaW5nW10+O1xuICAgIC8qKiBUaGUgTmFtZXNwYWNlIG9iamVjdCB1c2VkIHRvIGNyZWF0ZSBuZXcgY2xhc3MgaW5zdGFuY2VzIGluIHRoaXMgR2FtZS4gKi9cbiAgICBuYW1lc3BhY2U6IEltbXV0YWJsZTxJQmFzZUdhbWVOYW1lc3BhY2U+O1xuICAgIC8qKiBUaGUgZGVsdGEgbWVyZ2VhYmxlIHNjaGVtYSB1c2VkIHRvIHZhbGlkYXRlIGFsbCBpbnB1dHMvb3V0cHV0cy4gKi9cbiAgICBzY2hlbWE6IEltbXV0YWJsZTxJQmFzZUdhbWVPYmplY3RTY2hlbWE+O1xuICAgIC8qKiBUaGUgaW5pdGlhbGl6ZWQgZ2FtZSBtYW5hZ2VyIHRoYXQgYWxyZWFkeSBoYXMgY29udHJvbCBvZiB0aGUgY2xpZW50cy4gKi9cbiAgICBtYW5hZ2VyOiBCYXNlR2FtZU1hbmFnZXI7XG4gICAgLyoqIEFuIGV2ZW50IHRvIGludm9rZSBvbmNlIHRoaXMgR2FtZSBoYXMgYmVlbiBmdWxseSBpbml0aWFsaXplZC4gKi9cbiAgICBnYW1lQ3JlYXRlZDogRXZlbnQ8e1xuICAgICAgICAvKiogVGhpcyBnYW1lLiAqL1xuICAgICAgICBnYW1lOiBCYXNlR2FtZTtcbiAgICAgICAgLyoqIFRoZSByb290RGVsdGFNZXJnZWFibGUgKi9cbiAgICAgICAgZ2FtZU9iamVjdHNEZWx0YU1lcmdlYWJsZTogRGVsdGFNZXJnZWFibGU7XG4gICAgfT47XG59XG5cbi8qKiBUaGUgYmFzZSBnYW1lIHRoYXQgYWxsIEdhbWUgY2xhc3NlcyBpbmhlcml0IGZyb20uICovXG5leHBvcnQgY2xhc3MgQmFzZUdhbWUgZXh0ZW5kcyBCYXNlR2FtZURlbHRhTWVyZ2VhYmxlcyB7XG4gICAgLyoqXG4gICAgICogVGhlIG1hbmFnZXIgb2YgdGhpcyBjbGFzcyB0aGF0IGhhbmRsZXMgZGVhbGluZyB3aXRoIHRoZSBzZXJ2ZXIgc3lzdGVtc1xuICAgICAqIGFuZCB0aGUgZ2FtZS5cbiAgICAgKi9cbiAgICBwdWJsaWMgcmVhZG9ubHkgbWFuYWdlcjogQmFzZUdhbWVNYW5hZ2VyO1xuXG4gICAgLyoqXG4gICAgICogVGhlIGFjdHVhbCBzZXR0aW5nIHZhbHVlcyB3ZSB3aWxsIHVzZSB0byBpbml0aWFsaXplIHRoaW5ncy5cbiAgICAgKi9cbiAgICBwdWJsaWMgcmVhZG9ubHkgc2V0dGluZ3MgPSBPYmplY3QuZnJlZXplKHRoaXMuc2V0dGluZ3NNYW5hZ2VyLnZhbHVlcyk7XG5cbiAgICAvKiogVGhlIG5hbWUgKGlkKSBvZiB0aGlzIGdhbWUuICovXG4gICAgcHVibGljIHJlYWRvbmx5IG5hbWUhOiBzdHJpbmc7XG5cbiAgICAvKiogVGhlIGlkIG9mIHRoZSBnYW1lIHNlc3Npb24gdGhpcyBnYW1lIGlzIHBsYXlpbmcgaW4uICovXG4gICAgcHVibGljIHJlYWRvbmx5IHNlc3Npb24hOiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBBIHNwZWNpYWwga2V5L3ZhbHVlIG9iamVjdCBpbmRleGVkIGJ5IEdhbWVPYmplY3QgaWQncyB0byB0aGUgYWN0dWFsXG4gICAgICogZ2FtZSBvYmplY3RcbiAgICAgKi9cbiAgICBwdWJsaWMgcmVhZG9ubHkgZ2FtZU9iamVjdHMhOiB7W2lkOiBzdHJpbmddOiBCYXNlR2FtZU9iamVjdCB8IHVuZGVmaW5lZH07XG5cbiAgICAvKipcbiAgICAgKiBUaGUgcGxheWVycyBwbGF5aW5nIHRoaXMgZ2FtZS5cbiAgICAgKi9cbiAgICBwdWJsaWMgcmVhZG9ubHkgcGxheWVycyE6IEJhc2VQbGF5ZXJbXTtcblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemVzIGEgZ2FtZS4gU2hvdWxkICoqb25seSoqIGJlIGRvbmUgYnkgdGhpcyBnYW1lJ3MgbWFuYWdlci5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBzZXR0aW5nc01hbmFnZXIgLSBUaGUgc2V0dGluZ3MgbWFuYWdlciBmb3IgdGhpcyBpbnN0YW5jZS5cbiAgICAgKiBAcGFyYW0gcmVxdWlyZWREYXRhIC0gVGhlIHJlcXVpcmVkIGluaXRpYWxpemF0aW9uIGRhdGEuXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByb3RlY3RlZCBzZXR0aW5nc01hbmFnZXI6IEJhc2VHYW1lU2V0dGluZ3NNYW5hZ2VyLFxuICAgICAgICByZXF1aXJlZERhdGE6IFJlYWRvbmx5PElCYXNlR2FtZVJlcXVpcmVkRGF0YT4sIC8vIG5vdCBJbW11dGFibGUsIGFzIHNvbWUgb2YgdGhlIHZhbHVlcyB3aWxsIG11dGF0ZVxuICAgICkge1xuICAgICAgICBzdXBlcih7XG4gICAgICAgICAgICBrZXk6IFwiZ2FtZVwiLFxuICAgICAgICAgICAgcGFyZW50OiByZXF1aXJlZERhdGEucm9vdERlbHRhTWVyZ2VhYmxlLFxuICAgICAgICAgICAgYXR0cmlidXRlc1NjaGVtYTogcmVxdWlyZWREYXRhLnNjaGVtYS5hdHRyaWJ1dGVzLFxuICAgICAgICAgICAgaW5pdGlhbFZhbHVlczogc2V0dGluZ3NNYW5hZ2VyLnZhbHVlcyxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gT3VyIHN1cGVyIGhhcyBub3cgY3JlYXRlZCBvdXIgZGVsdGEgbWVyZ2VhYmxlcyxcbiAgICAgICAgLy8gbGV0J3MgcmVhY2ggaW4gYW5kIGdyYWIgdGhlIGdhbWUgb2JqZWN0cyBhbGwgaGFjay15IGxpa2UuXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1hbnkgbm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgICAgIGNvbnN0IGdhbWVPYmplY3RzRGVsdGFNZXJnZWFibGUgPSAoKHRoaXMgYXMgYW55KS5kZWx0YU1lcmdlYWJsZSBhcyBEZWx0YU1lcmdlYWJsZSkuY2hpbGQoXCJnYW1lT2JqZWN0c1wiKSE7XG5cbiAgICAgICAgdGhpcy5tYW5hZ2VyID0gcmVxdWlyZWREYXRhLm1hbmFnZXI7XG5cbiAgICAgICAgdGhpcy5uYW1lID0gcmVxdWlyZWREYXRhLm5hbWVzcGFjZS5nYW1lTmFtZTtcbiAgICAgICAgdGhpcy5zZXNzaW9uID0gcmVxdWlyZWREYXRhLnNlc3Npb25JRDtcblxuICAgICAgICBjb25zdCBjbGllbnRzID0gcmVxdWlyZWREYXRhLnBsYXlpbmdDbGllbnRzO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNsaWVudHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IGNsaWVudCA9IGNsaWVudHNbaV07XG4gICAgICAgICAgICBjbGllbnQuYWlNYW5hZ2VyLmdhbWUgPSB0aGlzOyAvLyBraW5kIG9mIGhhY2steSwgd2UgYXJlIGhvb2tpbmcgdGhpcyB1cCBoZXJlXG5cbiAgICAgICAgICAgIGNvbnN0IHBsYXllckRhdGE6IElCYXNlUGxheWVyRGF0YSA9IHtcbiAgICAgICAgICAgICAgICBuYW1lOiB0aGlzLnNldHRpbmdzLnBsYXllck5hbWVzW2ldIHx8IGNsaWVudC5uYW1lIHx8IGBQbGF5ZXIgJHtpfWAsXG4gICAgICAgICAgICAgICAgY2xpZW50VHlwZTogY2xpZW50LnByb2dyYW1taW5nTGFuZ3VhZ2UgfHwgXCJVbmtub3duXCIsXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBjb25zdCBwbGF5ZXIgPSBjcmVhdGVHYW1lT2JqZWN0PEJhc2VQbGF5ZXI+KHtcbiAgICAgICAgICAgICAgICBpZDogcmVxdWlyZWREYXRhLnBsYXllcklEc1tpXSxcbiAgICAgICAgICAgICAgICBnYW1lOiB0aGlzLFxuICAgICAgICAgICAgICAgIGdhbWVPYmplY3RzRGVsdGFNZXJnZWFibGUsXG4gICAgICAgICAgICAgICAgZ2FtZU9iamVjdE5hbWU6IFwiUGxheWVyXCIsXG4gICAgICAgICAgICAgICAgR2FtZU9iamVjdENsYXNzOiByZXF1aXJlZERhdGEubmFtZXNwYWNlLlBsYXllcixcbiAgICAgICAgICAgICAgICBnYW1lTmFtZXNwYWNlOiByZXF1aXJlZERhdGEubmFtZXNwYWNlLFxuICAgICAgICAgICAgICAgIGRhdGE6IHBsYXllckRhdGEsXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgcGxheWVyLnRpbWVSZW1haW5pbmcgPSB0aGlzLnNldHRpbmdzLnBsYXllclN0YXJ0aW5nVGltZTtcbiAgICAgICAgICAgIHBsYXllci5haSA9IG5ldyByZXF1aXJlZERhdGEubmFtZXNwYWNlLkFJKGNsaWVudC5haU1hbmFnZXIpO1xuXG4gICAgICAgICAgICBjbGllbnQuc2V0UGxheWVyKHBsYXllcik7XG4gICAgICAgICAgICB0aGlzLnBsYXllcnMucHVzaChwbGF5ZXIpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmVxdWlyZWREYXRhLmdhbWVDcmVhdGVkLmVtaXQoe1xuICAgICAgICAgICAgZ2FtZTogdGhpcyxcbiAgICAgICAgICAgIGdhbWVPYmplY3RzRGVsdGFNZXJnZWFibGUsXG4gICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==