"use strict";
// This is the script that can be thought of as the 'main.js' for each worker
// thread that spins up a game session into an Instance using true
// multi-threading
Object.defineProperty(exports, "__esModule", { value: true });
const setup_thread_1 = require("../setup-thread");
setup_thread_1.setupThread(); // we have to do this before doing aliased imports below
const cluster_1 = require("cluster");
const Clients = require("~/core/clients");
const config_1 = require("~/core/config");
const logger_1 = require("~/core/logger");
const session_1 = require("./session");
if (cluster_1.isMaster) {
    /* tslint:disable-next-line:no-console */
    console.error("ERROR: worker running on master thread");
    process.exit(1); // worker threads not intended to run on main thread.
}
if (!config_1.Config.WORKER_DATA) {
    throw new Error("Configs WORKER_DATA not set, worker cannot work");
}
const workerData = config_1.Config.WORKER_DATA;
process.title = `${workerData.gameName} - ${workerData.sessionID}`;
// tslint:disable-next-line:no-var-requires non-literal-require - as we need it to be synchronous and dynamic
const required = require(`~/games/${workerData.gameName.toLowerCase()}/`);
if (!required.Namespace) {
    throw new Error("Error required game namespace not found!");
}
const gameNamespace = required.Namespace;
const clients = [];
process.on("message", (message, socket) => {
    if (typeof message !== "object" || !message || !message.type) {
        throw new Error(`Could not understand message from parent thread to worker: '${message}'`);
    }
    if (message.type === "client") {
        // then we've been sent a new client to connect
        if (!socket) {
            throw new Error("Sockets must be sent with client data!");
        }
        const info = message.clientInfo;
        const { className } = info;
        const baseClientClass = Clients[className];
        if (!baseClientClass) {
            throw new Error(`Session cannot handle client ${className}`);
        }
        // Disable Nagle
        socket.setNoDelay(true);
        const client = new baseClientClass(socket);
        clients.push(client);
        client.sendMetaDeltas = info.metaDeltas;
        client.isSpectating = info.spectating;
        client.setInfo(info);
    }
    else if (message.type === "done") {
        // we've been sent all the sockets for the clients,
        // so we are ready to start!
        const session = new session_1.Session({
            id: workerData.sessionID,
            clients,
            gameNamespace,
            gameSettingsManager: new gameNamespace.GameSettingsManager(workerData.gameSettings),
        });
        process.on("unhandledRejection", (reason, p) => {
            session.kill(`Unhandled promise: ${reason}`);
        });
        process.on("uncaughtException", (err) => {
            session.kill(`Uncaught exception thrown: ${err.message}`);
        });
        session.events.ended.once((data) => {
            const error = data instanceof Error
                ? data
                : undefined;
            const success = data instanceof Error
                ? undefined
                : data;
            if (error) {
                logger_1.logger.error(`Worker thread ending because of error: ${error}`);
            }
            if (!process.send) {
                throw new Error("Worker not on separate thread!");
            }
            process.send({ error, ...success }, () => {
                process.exit(error ? 1 : 0);
            });
        });
    }
    else {
        throw new Error("Unexpected message from main thread");
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid29ya2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvcmUvc2VydmVyL3dvcmtlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsNkVBQTZFO0FBQzdFLGtFQUFrRTtBQUNsRSxrQkFBa0I7O0FBRWxCLGtEQUE4QztBQUM5QywwQkFBVyxFQUFFLENBQUMsQ0FBQyx3REFBd0Q7QUFJdkUscUNBQW1DO0FBRW5DLDBDQUEwQztBQUMxQywwQ0FBdUM7QUFDdkMsMENBQXVDO0FBR3ZDLHVDQUFvQztBQXFEcEMsSUFBSSxrQkFBUSxFQUFFO0lBQ1YseUNBQXlDO0lBQ3pDLE9BQU8sQ0FBQyxLQUFLLENBQUMsd0NBQXdDLENBQUMsQ0FBQztJQUN4RCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMscURBQXFEO0NBQ3pFO0FBRUQsSUFBSSxDQUFDLGVBQU0sQ0FBQyxXQUFXLEVBQUU7SUFDckIsTUFBTSxJQUFJLEtBQUssQ0FBQyxpREFBaUQsQ0FBQyxDQUFDO0NBQ3RFO0FBQ0QsTUFBTSxVQUFVLEdBQUcsZUFBTSxDQUFDLFdBQVcsQ0FBQztBQUV0QyxPQUFPLENBQUMsS0FBSyxHQUFHLEdBQUcsVUFBVSxDQUFDLFFBQVEsTUFBTSxVQUFVLENBQUMsU0FBUyxFQUFFLENBQUM7QUFFbkUsNkdBQTZHO0FBQzdHLE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxXQUFXLFVBQVUsQ0FBQyxRQUFRLENBQUMsV0FBVyxFQUFFLEdBQUcsQ0FBaUIsQ0FBQztBQUUxRixJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsRUFBRTtJQUNyQixNQUFNLElBQUksS0FBSyxDQUFDLDBDQUEwQyxDQUFDLENBQUM7Q0FDL0Q7QUFFRCxNQUFNLGFBQWEsR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFDO0FBRXpDLE1BQU0sT0FBTyxHQUF5QixFQUFFLENBQUM7QUFDekMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FD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QUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDaEMsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztLQUNOO1NBQ0k7UUFDRCxNQUFNLElBQUksS0FBSyxDQUFDLHFDQUFxQyxDQUFDLENBQUM7S0FDMUQ7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIFRoaXMgaXMgdGhlIHNjcmlwdCB0aGF0IGNhbiBiZSB0aG91Z2h0IG9mIGFzIHRoZSAnbWFpbi5qcycgZm9yIGVhY2ggd29ya2VyXG4vLyB0aHJlYWQgdGhhdCBzcGlucyB1cCBhIGdhbWUgc2Vzc2lvbiBpbnRvIGFuIEluc3RhbmNlIHVzaW5nIHRydWVcbi8vIG11bHRpLXRocmVhZGluZ1xuXG5pbXBvcnQgeyBzZXR1cFRocmVhZCB9IGZyb20gXCIuLi9zZXR1cC10aHJlYWRcIjtcbnNldHVwVGhyZWFkKCk7IC8vIHdlIGhhdmUgdG8gZG8gdGhpcyBiZWZvcmUgZG9pbmcgYWxpYXNlZCBpbXBvcnRzIGJlbG93XG5cbi8vIHRoaXMgYWxzbyBsb2FkcyB0aGUgY29tbWFuZCBsaW5lIGFyZ3VtZW50cyBmcm9tIHByb2Nlc3MuZW52XG5pbXBvcnQgeyBJR2FtZWxvZyB9IGZyb20gXCJAY2FkcmUvdHMtdXRpbHMvY2FkcmVcIjtcbmltcG9ydCB7IGlzTWFzdGVyIH0gZnJvbSBcImNsdXN0ZXJcIjtcbmltcG9ydCB7IFNvY2tldCB9IGZyb20gXCJuZXRcIjtcbmltcG9ydCAqIGFzIENsaWVudHMgZnJvbSBcIn4vY29yZS9jbGllbnRzXCI7XG5pbXBvcnQgeyBDb25maWcgfSBmcm9tIFwifi9jb3JlL2NvbmZpZ1wiO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIn4vY29yZS9sb2dnZXJcIjtcbmltcG9ydCB7IEltbXV0YWJsZSwgVW5rbm93bk9iamVjdCB9IGZyb20gXCJ+L3V0aWxzXCI7XG5pbXBvcnQgeyBJR2FtZXNFeHBvcnQgfSBmcm9tIFwiLi9nYW1lcy1leHBvcnRcIjtcbmltcG9ydCB7IFNlc3Npb24gfSBmcm9tIFwiLi9zZXNzaW9uXCI7XG5cbi8qKlxuICogQW4gaW50ZXJmYWNlIGZvciB0aGUgbWFpbiB0aHJlYWQgdG8gYWRoZXJlIHRvLCBzbyB3ZSBjYW4gY29tbXVuaWNhdGVcbiAqIGJvdGggc2FmZWx5LCBhbmQgcm9idXN0bHkuXG4gKi9cbmV4cG9ydCB0eXBlIE1lc3NhZ2VGcm9tTWFpblRocmVhZCA9IHtcbiAgICAvKiogRG9uZSBpbmRpY2F0aW5nIHRoZSBtYWluIHRocmVhZCBpcyBkb25lIHNlbmRpbmcgY2xpZW50cy4gKi9cbiAgICB0eXBlOiBcImRvbmVcIjtcbn0gfCB7XG4gICAgLyoqIFRoZSB0eXBlIGluZGljYXRpbmcgYSBuZXcgY2xpZW50IHNvY2tldCB0byBpbmplY3QuICovXG4gICAgdHlwZTogXCJjbGllbnRcIjtcbiAgICAvKiogVGhlIGluZm8gYWJvdXQgdGhlIGNsaWVudCB0byByZS1jb25zdHJ1Y3QgdGhlaXIgQ2xpZW50IGluc3RhbmNlLiAqL1xuICAgIGNsaWVudEluZm86IHtcbiAgICAgICAgLyoqIHRoZSBuYW1lIG9mIHRoZSBjbGFzcyBpbnN0YW5jZSBpbiB0aGUgQ2xpZW50cy8gZXhwb3J0ICovXG4gICAgICAgIGNsYXNzTmFtZTogc3RyaW5nO1xuICAgICAgICAvKiogVGhlaXIgcGxheWVyIGluZGV4LCBpZiB0aGV5IGFyZSBhIHBsYXllci4gKi9cbiAgICAgICAgaW5kZXg/OiBudW1iZXI7XG4gICAgICAgIC8qKiBUaGVpciBwbGF5ZXIgbmFtZSAqL1xuICAgICAgICBuYW1lOiBzdHJpbmc7XG4gICAgICAgIC8qKiBUaGUgdHlwZSBvZiBjbGllbnQgKi9cbiAgICAgICAgdHlwZTogc3RyaW5nO1xuICAgICAgICAvKiogRmxhZyBpbmRpY2F0aW5nIGlmIHRoZXkgYXJlIHNwZWN0YXRpbmcgb3Igbm90LiAqL1xuICAgICAgICBzcGVjdGF0aW5nOiBib29sZWFuO1xuICAgICAgICAvKiogRmxhZyBpbmRpY2F0aW5nIGlmIHRoZXkgd2FudCBtZXRhIGRlbHRhcyBvciBub3JtYWwgZGVsdGFzLiAqL1xuICAgICAgICBtZXRhRGVsdGFzOiBib29sZWFuO1xuICAgIH07XG59O1xuXG4vKiogVGhlIG1lc3NhZ2UgaW50ZXJmYWNlIHdvcmtlcnMgc2VuZCBmcm9tIHRoZW0gYXMgbWVzc2FnZXMgKi9cbmV4cG9ydCBpbnRlcmZhY2UgSVdvcmtlck92ZXJNZXNzYWdlIHtcbiAgICAvKiogQW4gZXJyb3IsIGlmIHNvbWV0aGluZyBiYWQgaGFwcGVuZWQgKi9cbiAgICBlcnJvcj86IEVycm9yO1xuXG4gICAgLyoqIFRoZSBnYW1lbG9nLCBpZiBldmVyeXRoaW5nIHdlbnQgc21vb3RobHkgYW5kIGl0IHdhcyBnZW5lcmF0ZWQgKi9cbiAgICBnYW1lbG9nPzogSW1tdXRhYmxlPElHYW1lbG9nPjtcblxuICAgIC8qKiBUaGUgY2xpZW50IGluZm9zIGZvciB0aGUgY29tcGxldGVkIGdhbWUuICovXG4gICAgY2xpZW50SW5mb3M/OiBDbGllbnRzLklDbGllbnRJbmZvW107XG59XG5cbi8qKiBUaGlzIGludGVyZmFjZSB3ZSBleHBlY3QgdG8gYmUgc2V0IHZpYSB0aGUgcHJvY2Vzcy5lbnYgZm9yIHVzLiAqL1xuZXhwb3J0IGludGVyZmFjZSBJV29ya2VyR2FtZVNlc3Npb25EYXRhIHtcbiAgICAvKiogT3B0aW9uYWwgZGVidWcgcG9ydCB0byBiaW5kIHRvIGZvciBkZWJ1Z2dlciBob29rcy4gKi9cbiAgICBtYWluRGVidWdQb3J0PzogbnVtYmVyO1xuICAgIC8qKiBUaGUgaWQgb2YgdGhlIHNlc3Npb24gd2UgYXJlIHRocmVhZGluZy4gKi9cbiAgICBzZXNzaW9uSUQ6IHN0cmluZztcbiAgICAvKiogVGhlIGdhbWUgbmFtZSAoaWQpIHRvIGNyZWF0ZS4gKi9cbiAgICBnYW1lTmFtZTogc3RyaW5nO1xuICAgIC8qKiBUaGUgZ2FtZSBzZXR0aW5ncyBmb3IgdGhpcyBzcGVjaWZpYyBnYW1lIGluc3RhbmNlIHRvIGJlIHBsYXllZC4gKi9cbiAgICBnYW1lU2V0dGluZ3M6IFVua25vd25PYmplY3Q7XG59XG5cbmlmIChpc01hc3Rlcikge1xuICAgIC8qIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1jb25zb2xlICovXG4gICAgY29uc29sZS5lcnJvcihcIkVSUk9SOiB3b3JrZXIgcnVubmluZyBvbiBtYXN0ZXIgdGhyZWFkXCIpO1xuICAgIHByb2Nlc3MuZXhpdCgxKTsgLy8gd29ya2VyIHRocmVhZHMgbm90IGludGVuZGVkIHRvIHJ1biBvbiBtYWluIHRocmVhZC5cbn1cblxuaWYgKCFDb25maWcuV09SS0VSX0RBVEEpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJDb25maWdzIFdPUktFUl9EQVRBIG5vdCBzZXQsIHdvcmtlciBjYW5ub3Qgd29ya1wiKTtcbn1cbmNvbnN0IHdvcmtlckRhdGEgPSBDb25maWcuV09SS0VSX0RBVEE7XG5cbnByb2Nlc3MudGl0bGUgPSBgJHt3b3JrZXJEYXRhLmdhbWVOYW1lfSAtICR7d29ya2VyRGF0YS5zZXNzaW9uSUR9YDtcblxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXZhci1yZXF1aXJlcyBub24tbGl0ZXJhbC1yZXF1aXJlIC0gYXMgd2UgbmVlZCBpdCB0byBiZSBzeW5jaHJvbm91cyBhbmQgZHluYW1pY1xuY29uc3QgcmVxdWlyZWQgPSByZXF1aXJlKGB+L2dhbWVzLyR7d29ya2VyRGF0YS5nYW1lTmFtZS50b0xvd2VyQ2FzZSgpfS9gKSBhcyBJR2FtZXNFeHBvcnQ7XG5cbmlmICghcmVxdWlyZWQuTmFtZXNwYWNlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiRXJyb3IgcmVxdWlyZWQgZ2FtZSBuYW1lc3BhY2Ugbm90IGZvdW5kIVwiKTtcbn1cblxuY29uc3QgZ2FtZU5hbWVzcGFjZSA9IHJlcXVpcmVkLk5hbWVzcGFjZTtcblxuY29uc3QgY2xpZW50czogQ2xpZW50cy5CYXNlQ2xpZW50W10gPSBbXTtcbnByb2Nlc3Mub24oXCJtZXNzYWdlXCIsIChcbiAgICBtZXNzYWdlOiBJbW11dGFibGU8TWVzc2FnZUZyb21NYWluVGhyZWFkPixcbiAgICBzb2NrZXQ/OiBTb2NrZXQsXG4pID0+IHtcbiAgICBpZiAodHlwZW9mIG1lc3NhZ2UgIT09IFwib2JqZWN0XCIgfHwgIW1lc3NhZ2UgfHwgIW1lc3NhZ2UudHlwZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCB1bmRlcnN0YW5kIG1lc3NhZ2UgZnJvbSBwYXJlbnQgdGhyZWFkIHRvIHdvcmtlcjogJyR7bWVzc2FnZX0nYCk7XG4gICAgfVxuXG4gICAgaWYgKG1lc3NhZ2UudHlwZSA9PT0gXCJjbGllbnRcIikge1xuICAgICAgICAvLyB0aGVuIHdlJ3ZlIGJlZW4gc2VudCBhIG5ldyBjbGllbnQgdG8gY29ubmVjdFxuICAgICAgICBpZiAoIXNvY2tldCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiU29ja2V0cyBtdXN0IGJlIHNlbnQgd2l0aCBjbGllbnQgZGF0YSFcIik7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBpbmZvID0gbWVzc2FnZS5jbGllbnRJbmZvO1xuICAgICAgICBjb25zdCB7IGNsYXNzTmFtZSB9ID0gaW5mbztcbiAgICAgICAgY29uc3QgYmFzZUNsaWVudENsYXNzID0gKENsaWVudHMgYXMgeyBba2V5OiBzdHJpbmddOiB0eXBlb2YgQ2xpZW50cy5CYXNlQ2xpZW50IHwgdW5kZWZpbmVkIH0pW2NsYXNzTmFtZV07XG5cbiAgICAgICAgaWYgKCFiYXNlQ2xpZW50Q2xhc3MpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgU2Vzc2lvbiBjYW5ub3QgaGFuZGxlIGNsaWVudCAke2NsYXNzTmFtZX1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIERpc2FibGUgTmFnbGVcbiAgICAgICAgc29ja2V0LnNldE5vRGVsYXkodHJ1ZSk7XG5cbiAgICAgICAgY29uc3QgY2xpZW50ID0gbmV3IGJhc2VDbGllbnRDbGFzcyhzb2NrZXQpO1xuICAgICAgICBjbGllbnRzLnB1c2goY2xpZW50KTtcblxuICAgICAgICBjbGllbnQuc2VuZE1ldGFEZWx0YXMgPSBpbmZvLm1ldGFEZWx0YXM7XG4gICAgICAgIGNsaWVudC5pc1NwZWN0YXRpbmcgPSBpbmZvLnNwZWN0YXRpbmc7XG4gICAgICAgIGNsaWVudC5zZXRJbmZvKGluZm8pO1xuICAgIH1cbiAgICBlbHNlIGlmIChtZXNzYWdlLnR5cGUgPT09IFwiZG9uZVwiKSB7XG4gICAgICAgIC8vIHdlJ3ZlIGJlZW4gc2VudCBhbGwgdGhlIHNvY2tldHMgZm9yIHRoZSBjbGllbnRzLFxuICAgICAgICAvLyBzbyB3ZSBhcmUgcmVhZHkgdG8gc3RhcnQhXG4gICAgICAgIGNvbnN0IHNlc3Npb24gPSBuZXcgU2Vzc2lvbih7XG4gICAgICAgICAgICBpZDogd29ya2VyRGF0YS5zZXNzaW9uSUQsXG4gICAgICAgICAgICBjbGllbnRzLFxuICAgICAgICAgICAgZ2FtZU5hbWVzcGFjZSxcbiAgICAgICAgICAgIGdhbWVTZXR0aW5nc01hbmFnZXI6IG5ldyBnYW1lTmFtZXNwYWNlLkdhbWVTZXR0aW5nc01hbmFnZXIod29ya2VyRGF0YS5nYW1lU2V0dGluZ3MpLFxuICAgICAgICB9KTtcblxuICAgICAgICBwcm9jZXNzLm9uKFwidW5oYW5kbGVkUmVqZWN0aW9uXCIsIChyZWFzb24sIHApID0+IHtcbiAgICAgICAgICAgIHNlc3Npb24ua2lsbChgVW5oYW5kbGVkIHByb21pc2U6ICR7cmVhc29ufWApO1xuICAgICAgICB9KTtcblxuICAgICAgICBwcm9jZXNzLm9uKFwidW5jYXVnaHRFeGNlcHRpb25cIiwgKGVycikgPT4ge1xuICAgICAgICAgICAgc2Vzc2lvbi5raWxsKGBVbmNhdWdodCBleGNlcHRpb24gdGhyb3duOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgICB9KTtcblxuICAgICAgICBzZXNzaW9uLmV2ZW50cy5lbmRlZC5vbmNlKChkYXRhKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBlcnJvciA9IGRhdGEgaW5zdGFuY2VvZiBFcnJvclxuICAgICAgICAgICAgICAgID8gZGF0YVxuICAgICAgICAgICAgICAgIDogdW5kZWZpbmVkO1xuICAgICAgICAgICAgY29uc3Qgc3VjY2VzcyA9IGRhdGEgaW5zdGFuY2VvZiBFcnJvclxuICAgICAgICAgICAgICAgID8gdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgOiBkYXRhO1xuXG4gICAgICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoYFdvcmtlciB0aHJlYWQgZW5kaW5nIGJlY2F1c2Ugb2YgZXJyb3I6ICR7ZXJyb3J9YCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghcHJvY2Vzcy5zZW5kKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiV29ya2VyIG5vdCBvbiBzZXBhcmF0ZSB0aHJlYWQhXCIpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBwcm9jZXNzLnNlbmQoeyBlcnJvciwgLi4uc3VjY2VzcyB9LCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgcHJvY2Vzcy5leGl0KGVycm9yID8gMSA6IDApO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVW5leHBlY3RlZCBtZXNzYWdlIGZyb20gbWFpbiB0aHJlYWRcIik7XG4gICAgfVxufSk7XG4iXX0=